function TimeStamp(){}function check(){$(sel).each(function(){var a=$(this).attr("href").split("/")[1];a==view()&&toggle(this)})}function clear(){$(sel).removeClass("selected")}function toggle(a){$(a).addClass("selected")}function view(){return window.location.hash.split("/")[1]}function tserv(a){return angular.element(document.body).injector().get(a)}String.prototype.smoosh=function(){return this.replace(/(\r\n+|\n+|\r+|\t+)/gm,"")},String.prototype.keyMe=function(){return this.toLowerCase().replace(" ","_")},String.prototype.lastInt=function(){return parseInt(this.replace(/.*?(\d+)[^\d]*$/,"$1"))},String.prototype.template=function(a){return this.replace(/{([^{}]*)}/g,function(b,c){var d=c.alphaOnly(),e=void 0;return void 0!=a&&d in a&&(e=a[d]),"string"==typeof e||"number"==typeof e?e:b})},String.prototype.escapeHtml=function(){var a={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};return this.replace(/[&<>]/g,function(b){return a[b]})},String.prototype.shellArgs=function(){if(""==this)return[];for(var a=this.match(/('.*?'|".*?"|[^"\s]+)/g),b=0;b<a.length;b++)a[b]=a[b].replace(/^"|"$|^'|'$/g,"");return a},String.prototype.splice=function(a,b){return this.slice(0,Math.abs(b))+a+this.slice(Math.abs(b))},String.prototype.noSpaceHtml=function(){var a=this.replace(/\n/g,"");return a=a.replace(/[\t ]+\</g,"<"),a=a.replace(/\>[\t ]+\</g,"><"),a=a.replace(/\>[\t ]+$/g,">")},String.prototype.stripTags=function(){return this.replace(/<\/?[^>]+(>|$)/g,"")},String.prototype.urnToPath=function(){var a=this.length,b=this;return"<"==b.substring(0,1)&&(b=b.substring(1,a-1)),">"==b.substring(a-1,1)&&(b=b.substring(0,a-2)),b=b.replace(/:/g,"/"),b=b.replace(/\./g,"/")},String.prototype.pathToUrn=function(a){var b=(this.length,this);if(b=b.replace(/\//g,":"),1==a){var c=b.lastIndexOf(":");b=b.substring(0,c)+"."+b.substring(c+1)}return b},String.prototype.oneSpace=function(){return this.replace(/\s{2,}/g," ")},String.prototype.alphaSpaceOnly=function(){return this.replace(/[^\w\s]/gi,"")},String.prototype.alphaOnly=function(){return this.replace(/[^\w]/gi,"")},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},String.prototype.repeat=function(a){return new Array(a+1).join(this)},String.prototype.occurs=function(a,b){var c=this;if(void 0==a)return c.length;if(a+="",a.length<=0)return c.length;for(var d=0,e=0,f=b?1:a.length;;){if(e=c.indexOf(a,e),!(e>=0))break;d++,e+=f}return d},String.prototype.positions=function(a,b,c,d){var e=this;a+="";for(var f=0,g=b?1:a.length,h=[];;){var i=!0;if(f=e.indexOf(a,f),!(f>=0))break;if(1==c)for(var j=f;j<e.length&&"<"!=e[j];j++)">"==e[j]&&(i=!1);1==d&&1==e.substr(f-1,f+a.length+1).isAlphaNum()&&(i=!1),1==i&&h.push(f),f+=g}return h},String.prototype.insertAt=function(a,b){return this.substr(0,a)+b+this.substr(a)},String.prototype.params=function(){var a=this.split("?"),b=a[1];a=b.split("&");for(var c={},d=0,e=a.length;e>d;d++)if(void 0!=a[d]){var f=a[d].split("=");c[f[0]]=f[1]}return c},String.prototype.toCamel=function(){return this.replace(/(\_[a-z])/g,function(a){return a.toUpperCase().replace("_","")})},String.prototype.hasUpper=function(){return/[A-Z]/.test(this)},String.prototype.report=function(){for(var a=this.toLowerCase().split(" "),b={},c=0,d=a.length;d>c;c++){var e=a[c];e in b?b[e]+=1:b[e]=1}return b},String.prototype.lastslash=function(){return this.lastIndexOf("/")},String.prototype.dirname=function(){return this.substring(0,this.lastslash()+1)},String.prototype.basename=function(){return this.substring(this.lastslash()+1,this.length)},String.prototype.lines=function(){return this.split("\n")},String.prototype.isAlphaNum=function(){return/[^a-zA-Z0-9]/.test(this)?!1:!0},String.prototype.file_name=function(){return this.toLowerCase().replace(/[^a-z0-9]/g,"_")},String.prototype.sentences=function(){for(var a=this.match(/[^\.!\?]+[\.!\?]+/g),b=["a","e","i","o","u","y"],c=[],d="",e=0;e<a.length;e++){var f=d+a[e];d="";for(var g=!0,h=0;h<b.length;h++)if(-1!=f.indexOf(b[h])){g=!1;break}var i=f.trim();i[0].hasUpper()||(g=!0),g?c.length>0?c[c.length-1]+=f:d=f:c.push(f.smoosh().trim())}return c},TimeStamp.prototype.xsd=function(){var a=new Date,b=a.getFullYear(),c=("0"+(a.getMonth()+1)).slice(-2),d=("0"+a.getDate()).slice(-2),e=a.getHours(),f=("0"+a.getMinutes()).slice(-2),g=("0"+a.getSeconds()).slice(-2),h=a.getTimezoneOffset(),i=b+"-"+c+"-"+d+" "+e+":"+f+":"+g+" ";return i=h>0?i+"+"+this.pad(4,h):i+"-"+this.pad(4,h)},TimeStamp.prototype.pad=function(a,b){return b<=parseInt("9".repeat(a))&&(b=("0".repeat(a-1)+b).slice(-a)),b},TimeStamp.prototype.withUtc=function(a){var b=new Date,c=b.getFullYear(),d=("0"+(b.getMonth()+1)).slice(-2),e=("0"+b.getDate()).slice(-2),f=b.getHours(),g=("0"+b.getMinutes()).slice(-2),h=("0"+b.getSeconds()).slice(-2),i=("0"+b.getMilliseconds()).slice(-3),j=b.getTimezoneOffset(),k="";return k=a?c+"-"+d+"-"+e+"T"+f+":"+g+":"+h+":"+i+"UTC":c+"-"+d+"-"+e+"T"+f+":"+g+":"+h+"UTC",k=j>0?k+"+"+j:k+"-"+j},TimeStamp.prototype.timeOfDay=function(){var a=new Date,b=a.getHours(),c=("0"+a.getMinutes()).slice(-2),d="AM";return b>12&&(b-=12,d="PM"),b=0==b?12:b,b+":"+c+" "+d},TimeStamp.prototype.unix=function(){return(new Date).getTime()},TimeStamp.prototype.toUnix=function(a){var b=a.replace(/UTC.*/,""),c=0;return b.match(/:\d{3}/)&&(c=b.slice(-4),b=b.replace(/:\d+$/,""),c=parseInt(c.replace(":",""))),Date.parse(b).getTime()+c},Date.CultureInfo={name:"en-US",englishName:"English (United States)",nativeName:"English (United States)",dayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],abbreviatedDayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],shortestDayNames:["Su","Mo","Tu","We","Th","Fr","Sa"],firstLetterDayNames:["S","M","T","W","T","F","S"],monthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],abbreviatedMonthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],amDesignator:"AM",pmDesignator:"PM",firstDayOfWeek:0,twoDigitYearMax:2029,dateElementOrder:"mdy",formatPatterns:{shortDate:"M/d/yyyy",longDate:"dddd, MMMM dd, yyyy",shortTime:"h:mm tt",longTime:"h:mm:ss tt",fullDateTime:"dddd, MMMM dd, yyyy h:mm:ss tt",sortableDateTime:"yyyy-MM-ddTHH:mm:ss",universalSortableDateTime:"yyyy-MM-dd HH:mm:ssZ",rfc1123:"ddd, dd MMM yyyy HH:mm:ss GMT",monthDay:"MMMM dd",yearMonth:"MMMM, yyyy"},regexPatterns:{jan:/^jan(uary)?/i,feb:/^feb(ruary)?/i,mar:/^mar(ch)?/i,apr:/^apr(il)?/i,may:/^may/i,jun:/^jun(e)?/i,jul:/^jul(y)?/i,aug:/^aug(ust)?/i,sep:/^sep(t(ember)?)?/i,oct:/^oct(ober)?/i,nov:/^nov(ember)?/i,dec:/^dec(ember)?/i,sun:/^su(n(day)?)?/i,mon:/^mo(n(day)?)?/i,tue:/^tu(e(s(day)?)?)?/i,wed:/^we(d(nesday)?)?/i,thu:/^th(u(r(s(day)?)?)?)?/i,fri:/^fr(i(day)?)?/i,sat:/^sa(t(urday)?)?/i,future:/^next/i,past:/^last|past|prev(ious)?/i,add:/^(\+|after|from)/i,subtract:/^(\-|before|ago)/i,yesterday:/^yesterday/i,today:/^t(oday)?/i,tomorrow:/^tomorrow/i,now:/^n(ow)?/i,millisecond:/^ms|milli(second)?s?/i,second:/^sec(ond)?s?/i,minute:/^min(ute)?s?/i,hour:/^h(ou)?rs?/i,week:/^w(ee)?k/i,month:/^m(o(nth)?s?)?/i,day:/^d(ays?)?/i,year:/^y((ea)?rs?)?/i,shortMeridian:/^(a|p)/i,longMeridian:/^(a\.?m?\.?|p\.?m?\.?)/i,timezone:/^((e(s|d)t|c(s|d)t|m(s|d)t|p(s|d)t)|((gmt)?\s*(\+|\-)\s*\d\d\d\d?)|gmt)/i,ordinalSuffix:/^\s*(st|nd|rd|th)/i,timeContext:/^\s*(\:|a|p)/i},abbreviatedTimeZoneStandard:{GMT:"-000",EST:"-0400",CST:"-0500",MST:"-0600",PST:"-0700"},abbreviatedTimeZoneDST:{GMT:"-000",EDT:"-0500",CDT:"-0600",MDT:"-0700",PDT:"-0800"}},Date.getMonthNumberFromName=function(a){for(var b=Date.CultureInfo.monthNames,c=Date.CultureInfo.abbreviatedMonthNames,d=a.toLowerCase(),e=0;e<b.length;e++)if(b[e].toLowerCase()==d||c[e].toLowerCase()==d)return e;return-1},Date.getDayNumberFromName=function(a){for(var b=Date.CultureInfo.dayNames,c=Date.CultureInfo.abbreviatedDayNames,d=(Date.CultureInfo.shortestDayNames,a.toLowerCase()),e=0;e<b.length;e++)if(b[e].toLowerCase()==d||c[e].toLowerCase()==d)return e;return-1},Date.isLeapYear=function(a){return a%4===0&&a%100!==0||a%400===0},Date.getDaysInMonth=function(a,b){return[31,Date.isLeapYear(a)?29:28,31,30,31,30,31,31,30,31,30,31][b]},Date.getTimezoneOffset=function(a,b){return b?Date.CultureInfo.abbreviatedTimeZoneDST[a.toUpperCase()]:Date.CultureInfo.abbreviatedTimeZoneStandard[a.toUpperCase()]},Date.getTimezoneAbbreviation=function(a,b){var c,d=b?Date.CultureInfo.abbreviatedTimeZoneDST:Date.CultureInfo.abbreviatedTimeZoneStandard;for(c in d)if(d[c]===a)return c;return null},Date.prototype.clone=function(){return new Date(this.getTime())},Date.prototype.compareTo=function(a){if(isNaN(this))throw new Error(this);if(a instanceof Date&&!isNaN(a))return this>a?1:a>this?-1:0;throw new TypeError(a)},Date.prototype.equals=function(a){return 0===this.compareTo(a)},Date.prototype.between=function(a,b){var c=this.getTime();return c>=a.getTime()&&c<=b.getTime()},Date.prototype.addMilliseconds=function(a){return this.setMilliseconds(this.getMilliseconds()+a),this},Date.prototype.addSeconds=function(a){return this.addMilliseconds(1e3*a)},Date.prototype.addMinutes=function(a){return this.addMilliseconds(6e4*a)},Date.prototype.addHours=function(a){return this.addMilliseconds(36e5*a)},Date.prototype.addDays=function(a){return this.addMilliseconds(864e5*a)},Date.prototype.addWeeks=function(a){return this.addMilliseconds(6048e5*a)},Date.prototype.addMonths=function(a){var b=this.getDate();return this.setDate(1),this.setMonth(this.getMonth()+a),this.setDate(Math.min(b,this.getDaysInMonth())),this},Date.prototype.addYears=function(a){return this.addMonths(12*a)},Date.prototype.add=function(a){if("number"==typeof a)return this._orient=a,this;var b=a;return(b.millisecond||b.milliseconds)&&this.addMilliseconds(b.millisecond||b.milliseconds),(b.second||b.seconds)&&this.addSeconds(b.second||b.seconds),(b.minute||b.minutes)&&this.addMinutes(b.minute||b.minutes),(b.hour||b.hours)&&this.addHours(b.hour||b.hours),(b.month||b.months)&&this.addMonths(b.month||b.months),(b.year||b.years)&&this.addYears(b.year||b.years),(b.day||b.days)&&this.addDays(b.day||b.days),this},Date._validate=function(a,b,c,d){if("number"!=typeof a)throw new TypeError(a+" is not a Number.");if(b>a||a>c)throw new RangeError(a+" is not a valid value for "+d+".");return!0},Date.validateMillisecond=function(a){return Date._validate(a,0,999,"milliseconds")},Date.validateSecond=function(a){return Date._validate(a,0,59,"seconds")},Date.validateMinute=function(a){return Date._validate(a,0,59,"minutes")},Date.validateHour=function(a){return Date._validate(a,0,23,"hours")},Date.validateDay=function(a,b,c){return Date._validate(a,1,Date.getDaysInMonth(b,c),"days")},Date.validateMonth=function(a){return Date._validate(a,0,11,"months")},Date.validateYear=function(a){return Date._validate(a,1,9999,"seconds")},Date.prototype.set=function(a){var b=a;return b.millisecond||0===b.millisecond||(b.millisecond=-1),b.second||0===b.second||(b.second=-1),b.minute||0===b.minute||(b.minute=-1),b.hour||0===b.hour||(b.hour=-1),b.day||0===b.day||(b.day=-1),b.month||0===b.month||(b.month=-1),b.year||0===b.year||(b.year=-1),-1!=b.millisecond&&Date.validateMillisecond(b.millisecond)&&this.addMilliseconds(b.millisecond-this.getMilliseconds()),-1!=b.second&&Date.validateSecond(b.second)&&this.addSeconds(b.second-this.getSeconds()),-1!=b.minute&&Date.validateMinute(b.minute)&&this.addMinutes(b.minute-this.getMinutes()),-1!=b.hour&&Date.validateHour(b.hour)&&this.addHours(b.hour-this.getHours()),-1!==b.month&&Date.validateMonth(b.month)&&this.addMonths(b.month-this.getMonth()),-1!=b.year&&Date.validateYear(b.year)&&this.addYears(b.year-this.getFullYear()),-1!=b.day&&Date.validateDay(b.day,this.getFullYear(),this.getMonth())&&this.addDays(b.day-this.getDate()),b.timezone&&this.setTimezone(b.timezone),b.timezoneOffset&&this.setTimezoneOffset(b.timezoneOffset),this},Date.prototype.clearTime=function(){return this.setHours(0),this.setMinutes(0),this.setSeconds(0),this.setMilliseconds(0),this},Date.prototype.isLeapYear=function(){var a=this.getFullYear();return a%4===0&&a%100!==0||a%400===0},Date.prototype.isWeekday=function(){return!(this.is().sat()||this.is().sun())},Date.prototype.getDaysInMonth=function(){return Date.getDaysInMonth(this.getFullYear(),this.getMonth())},Date.prototype.moveToFirstDayOfMonth=function(){return this.set({day:1})},Date.prototype.moveToLastDayOfMonth=function(){return this.set({day:this.getDaysInMonth()})},Date.prototype.moveToDayOfWeek=function(a,b){var c=(a-this.getDay()+7*(b||1))%7;return this.addDays(0===c?c+=7*(b||1):c)},Date.prototype.moveToMonth=function(a,b){var c=(a-this.getMonth()+12*(b||1))%12;return this.addMonths(0===c?c+=12*(b||1):c)},Date.prototype.getDayOfYear=function(){return Math.floor((this-new Date(this.getFullYear(),0,1))/864e5)},Date.prototype.getWeekOfYear=function(a){var b=this.getFullYear(),c=this.getMonth(),d=this.getDate(),e=a||Date.CultureInfo.firstDayOfWeek,f=8-new Date(b,0,1).getDay();8==f&&(f=1);var g=(Date.UTC(b,c,d,0,0,0)-Date.UTC(b,0,1,0,0,0))/864e5+1,h=Math.floor((g-f+7)/7);if(h===e){b--;var i=8-new Date(b,0,1).getDay();h=2==i||8==i?53:52}return h},Date.prototype.isDST=function(){return console.log("isDST"),"D"==this.toString().match(/(E|C|M|P)(S|D)T/)[2]},Date.prototype.getTimezone=function(){return Date.getTimezoneAbbreviation(this.getUTCOffset,this.isDST())},Date.prototype.setTimezoneOffset=function(a){var b=this.getTimezoneOffset(),c=-6*Number(a)/10;return this.addMinutes(c-b),this},Date.prototype.setTimezone=function(a){return this.setTimezoneOffset(Date.getTimezoneOffset(a))},Date.prototype.getUTCOffset=function(){var a,b=-10*this.getTimezoneOffset()/6;return 0>b?(a=(b-1e4).toString(),a[0]+a.substr(2)):(a=(b+1e4).toString(),"+"+a.substr(1))},Date.prototype.getDayName=function(a){return a?Date.CultureInfo.abbreviatedDayNames[this.getDay()]:Date.CultureInfo.dayNames[this.getDay()]},Date.prototype.getMonthName=function(a){return a?Date.CultureInfo.abbreviatedMonthNames[this.getMonth()]:Date.CultureInfo.monthNames[this.getMonth()]},Date.prototype._toString=Date.prototype.toString,Date.prototype.toString=function(a){var b=this,c=function(a){return 1==a.toString().length?"0"+a:a};return a?a.replace(/dd?d?d?|MM?M?M?|yy?y?y?|hh?|HH?|mm?|ss?|tt?|zz?z?/g,function(a){switch(a){case"hh":return c(b.getHours()<13?b.getHours():b.getHours()-12);case"h":return b.getHours()<13?b.getHours():b.getHours()-12;case"HH":return c(b.getHours());case"H":return b.getHours();case"mm":return c(b.getMinutes());case"m":return b.getMinutes();case"ss":return c(b.getSeconds());case"s":return b.getSeconds();case"yyyy":return b.getFullYear();case"yy":return b.getFullYear().toString().substring(2,4);case"dddd":return b.getDayName();case"ddd":return b.getDayName(!0);case"dd":return c(b.getDate());case"d":return b.getDate().toString();case"MMMM":return b.getMonthName();case"MMM":return b.getMonthName(!0);case"MM":return c(b.getMonth()+1);case"M":return b.getMonth()+1;case"t":return b.getHours()<12?Date.CultureInfo.amDesignator.substring(0,1):Date.CultureInfo.pmDesignator.substring(0,1);case"tt":return b.getHours()<12?Date.CultureInfo.amDesignator:Date.CultureInfo.pmDesignator;case"zzz":case"zz":case"z":return""}}):this._toString()},Date.now=function(){return new Date},Date.today=function(){return Date.now().clearTime()},Date.prototype._orient=1,Date.prototype.next=function(){return this._orient=1,this},Date.prototype.last=Date.prototype.prev=Date.prototype.previous=function(){return this._orient=-1,this},Date.prototype._is=!1,Date.prototype.is=function(){return this._is=!0,this},Number.prototype._dateElement="day",Number.prototype.fromNow=function(){var a={};return a[this._dateElement]=this,Date.now().add(a)},Number.prototype.ago=function(){var a={};return a[this._dateElement]=-1*this,Date.now().add(a)},function(){for(var a,b=Date.prototype,c=Number.prototype,d="sunday monday tuesday wednesday thursday friday saturday".split(/\s/),e="january february march april may june july august september october november december".split(/\s/),f="Millisecond Second Minute Hour Day Week Month Year".split(/\s/),g=function(a){return function(){return this._is?(this._is=!1,this.getDay()==a):this.moveToDayOfWeek(a,this._orient)}},h=0;h<d.length;h++)b[d[h]]=b[d[h].substring(0,3)]=g(h);for(var i=function(a){return function(){return this._is?(this._is=!1,this.getMonth()===a):this.moveToMonth(a,this._orient)}},j=0;j<e.length;j++)b[e[j]]=b[e[j].substring(0,3)]=i(j);for(var k=function(a){return function(){return"s"!=a.substring(a.length-1)&&(a+="s"),this["add"+a](this._orient)}},l=function(a){return function(){return this._dateElement=a,this}},m=0;m<f.length;m++)a=f[m].toLowerCase(),b[a]=b[a+"s"]=k(f[m]),c[a]=c[a+"s"]=l(a)}(),Date.prototype.toJSONString=function(){return this.toString("yyyy-MM-ddThh:mm:ssZ")},Date.prototype.toShortDateString=function(){return this.toString(Date.CultureInfo.formatPatterns.shortDatePattern)},Date.prototype.toLongDateString=function(){return this.toString(Date.CultureInfo.formatPatterns.longDatePattern)},Date.prototype.toShortTimeString=function(){return this.toString(Date.CultureInfo.formatPatterns.shortTimePattern)},Date.prototype.toLongTimeString=function(){return this.toString(Date.CultureInfo.formatPatterns.longTimePattern)},Date.prototype.getOrdinal=function(){switch(this.getDate()){case 1:case 21:case 31:return"st";case 2:case 22:return"nd";case 3:case 23:return"rd";default:return"th"}},function(){Date.Parsing={Exception:function(a){this.message="Parse error at '"+a.substring(0,10)+" ...'"}};for(var a=Date.Parsing,b=a.Operators={rtoken:function(b){return function(c){var d=c.match(b);if(d)return[d[0],c.substring(d[0].length)];throw new a.Exception(c)}},token:function(){return function(a){return b.rtoken(new RegExp("^s*"+a+"s*"))(a)}},stoken:function(a){return b.rtoken(new RegExp("^"+a))},until:function(a){return function(b){for(var c=[],d=null;b.length;){try{d=a.call(this,b)}catch(e){c.push(d[0]),b=d[1];continue}break}return[c,b]}},many:function(a){return function(b){for(var c=[],d=null;b.length;){try{d=a.call(this,b)}catch(e){return[c,b]}c.push(d[0]),b=d[1]}return[c,b]}},optional:function(a){return function(b){var c=null;try{c=a.call(this,b)}catch(d){return[null,b]}return[c[0],c[1]]}},not:function(b){return function(c){try{b.call(this,c)}catch(d){return[null,c]}throw new a.Exception(c)}},ignore:function(a){return a?function(b){var c=null;return c=a.call(this,b),[null,c[1]]}:null},product:function(){for(var a=arguments[0],c=Array.prototype.slice.call(arguments,1),d=[],e=0;e<a.length;e++)d.push(b.each(a[e],c));return d},cache:function(b){var c={},d=null;return function(e){try{d=c[e]=c[e]||b.call(this,e)}catch(f){d=c[e]=f}if(d instanceof a.Exception)throw d;return d}},any:function(){var b=arguments;return function(c){for(var d=null,e=0;e<b.length;e++)if(null!=b[e]){try{d=b[e].call(this,c)}catch(f){d=null}if(d)return d}throw new a.Exception(c)}},each:function(){var b=arguments;return function(c){for(var d=[],e=null,f=0;f<b.length;f++)if(null!=b[f]){try{e=b[f].call(this,c)}catch(g){throw new a.Exception(c)}d.push(e[0]),c=e[1]}return[d,c]}},all:function(){var a=arguments,b=b;return b.each(b.optional(a))},sequence:function(c,d,e){return d=d||b.rtoken(/^\s*/),e=e||null,1==c.length?c[0]:function(b){for(var f=null,g=null,h=[],i=0;i<c.length;i++){try{f=c[i].call(this,b)}catch(j){break}h.push(f[0]);try{g=d.call(this,f[1])}catch(k){g=null;break}b=g[1]}if(!f)throw new a.Exception(b);if(g)throw new a.Exception(g[1]);if(e)try{f=e.call(this,f[1])}catch(l){throw new a.Exception(f[1])}return[h,f?f[1]:b]}},between:function(a,c,d){d=d||a;var e=b.each(b.ignore(a),c,b.ignore(d));return function(a){var b=e.call(this,a);return[[b[0][0],r[0][2]],b[1]]}},list:function(a,c,d){return c=c||b.rtoken(/^\s*/),d=d||null,a instanceof Array?b.each(b.product(a.slice(0,-1),b.ignore(c)),a.slice(-1),b.ignore(d)):b.each(b.many(b.each(a,b.ignore(c))),px,b.ignore(d))},set:function(c,d,e){return d=d||b.rtoken(/^\s*/),e=e||null,function(f){for(var g=null,h=null,i=null,j=null,k=[[],f],l=!1,m=0;m<c.length;m++){i=null,h=null,g=null,l=1==c.length;try{g=c[m].call(this,f)}catch(n){continue}if(j=[[g[0]],g[1]],g[1].length>0&&!l)try{i=d.call(this,g[1])}catch(o){l=!0}else l=!0;if(l||0!==i[1].length||(l=!0),!l){for(var p=[],q=0;q<c.length;q++)m!=q&&p.push(c[q]);h=b.set(p,d).call(this,i[1]),h[0].length>0&&(j[0]=j[0].concat(h[0]),j[1]=h[1])}if(j[1].length<k[1].length&&(k=j),0===k[1].length)break}if(0===k[0].length)return k;if(e){try{i=e.call(this,k[1])}catch(r){throw new a.Exception(k[1])}k[1]=i[1]}return k}},forward:function(a,b){return function(c){return a[b].call(this,c)}},replace:function(a,b){return function(c){var d=a.call(this,c);return[b,d[1]]}},process:function(a,b){return function(c){var d=a.call(this,c);return[b.call(this,d[0]),d[1]]}},min:function(b,c){return function(d){var e=c.call(this,d);if(e[0].length<b)throw new a.Exception(d);return e}}},c=function(a){return function(){var b=null,c=[];if(arguments.length>1?b=Array.prototype.slice.call(arguments):arguments[0]instanceof Array&&(b=arguments[0]),!b)return a.apply(null,arguments);for(var d=0,e=b.shift();d<e.length;d++)return b.unshift(e[d]),c.push(a.apply(null,b)),b.shift(),c}},d="optional not ignore cache".split(/\s/),e=0;e<d.length;e++)b[d[e]]=c(b[d[e]]);for(var f=function(a){return function(){return arguments[0]instanceof Array?a.apply(null,arguments[0]):a.apply(null,arguments)}},g="each any all".split(/\s/),h=0;h<g.length;h++)b[g[h]]=f(b[g[h]])}(),function(){var a=function(b){for(var c=[],d=0;d<b.length;d++)b[d]instanceof Array?c=c.concat(a(b[d])):b[d]&&c.push(b[d]);return c};Date.Grammar={},Date.Translator={hour:function(a){return function(){this.hour=Number(a)}},minute:function(a){return function(){this.minute=Number(a)}},second:function(a){return function(){this.second=Number(a)}},meridian:function(a){return function(){this.meridian=a.slice(0,1).toLowerCase()}},timezone:function(a){return function(){var b=a.replace(/[^\d\+\-]/g,"");b.length?this.timezoneOffset=Number(b):this.timezone=a.toLowerCase()}},day:function(a){var b=a[0];return function(){this.day=Number(b.match(/\d+/)[0])}},month:function(a){return function(){this.month=3==a.length?Date.getMonthNumberFromName(a):Number(a)-1}},year:function(a){return function(){var b=Number(a);this.year=a.length>2?b:b+(b+2e3<Date.CultureInfo.twoDigitYearMax?2e3:1900)}},rday:function(a){return function(){switch(a){case"yesterday":this.days=-1;break;case"tomorrow":this.days=1;break;case"today":this.days=0;break;case"now":this.days=0,this.now=!0}}},finishExact:function(a){a=a instanceof Array?a:[a];var b=new Date;this.year=b.getFullYear(),this.month=b.getMonth(),this.day=1,this.hour=0,this.minute=0,this.second=0;for(var c=0;c<a.length;c++)a[c]&&a[c].call(this);if(this.hour="p"==this.meridian&&this.hour<13?this.hour+12:this.hour,this.day>Date.getDaysInMonth(this.year,this.month))throw new RangeError(this.day+" is not a valid value for days.");var d=new Date(this.year,this.month,this.day,this.hour,this.minute,this.second);return this.timezone?d.set({timezone:this.timezone}):this.timezoneOffset&&d.set({timezoneOffset:this.timezoneOffset}),d},finish:function(b){if(b=b instanceof Array?a(b):[b],0===b.length)return null;for(var c=0;c<b.length;c++)"function"==typeof b[c]&&b[c].call(this);if(this.now)return new Date;var d=Date.today(),e=!(null==this.days&&!this.orient&&!this.operator);if(e){var f,g,h;return h="past"==this.orient||"subtract"==this.operator?-1:1,this.weekday&&(this.unit="day",f=Date.getDayNumberFromName(this.weekday)-d.getDay(),g=7,this.days=f?(f+h*g)%g:h*g),this.month&&(this.unit="month",f=this.month-d.getMonth(),g=12,this.months=f?(f+h*g)%g:h*g,this.month=null),this.unit||(this.unit="day"),(null==this[this.unit+"s"]||null!=this.operator)&&(this.value||(this.value=1),"week"==this.unit&&(this.unit="day",this.value=7*this.value),this[this.unit+"s"]=this.value*h),d.add(this)}return this.meridian&&this.hour&&(this.hour=this.hour<13&&"p"==this.meridian?this.hour+12:this.hour),this.weekday&&!this.day&&(this.day=d.addDays(Date.getDayNumberFromName(this.weekday)-d.getDay()).getDate()),this.month&&!this.day&&(this.day=1),d.set(this)}};var b,c=Date.Parsing.Operators,d=Date.Grammar,e=Date.Translator;d.datePartDelimiter=c.rtoken(/^([\s\-\.\,\/\x27]+)/),d.timePartDelimiter=c.stoken(":"),d.whiteSpace=c.rtoken(/^\s*/),d.generalDelimiter=c.rtoken(/^(([\s\,]|at|on)+)/);var f={};d.ctoken=function(a){var b=f[a];if(!b){for(var d=Date.CultureInfo.regexPatterns,e=a.split(/\s+/),g=[],h=0;h<e.length;h++)g.push(c.replace(c.rtoken(d[e[h]]),e[h]));b=f[a]=c.any.apply(null,g)}return b},d.ctoken2=function(a){return c.rtoken(Date.CultureInfo.regexPatterns[a])},d.h=c.cache(c.process(c.rtoken(/^(0[0-9]|1[0-2]|[1-9])/),e.hour)),d.hh=c.cache(c.process(c.rtoken(/^(0[0-9]|1[0-2])/),e.hour)),d.H=c.cache(c.process(c.rtoken(/^([0-1][0-9]|2[0-3]|[0-9])/),e.hour)),d.HH=c.cache(c.process(c.rtoken(/^([0-1][0-9]|2[0-3])/),e.hour)),d.m=c.cache(c.process(c.rtoken(/^([0-5][0-9]|[0-9])/),e.minute)),d.mm=c.cache(c.process(c.rtoken(/^[0-5][0-9]/),e.minute)),d.s=c.cache(c.process(c.rtoken(/^([0-5][0-9]|[0-9])/),e.second)),d.ss=c.cache(c.process(c.rtoken(/^[0-5][0-9]/),e.second)),d.hms=c.cache(c.sequence([d.H,d.mm,d.ss],d.timePartDelimiter)),d.t=c.cache(c.process(d.ctoken2("shortMeridian"),e.meridian)),d.tt=c.cache(c.process(d.ctoken2("longMeridian"),e.meridian)),d.z=c.cache(c.process(c.rtoken(/^(\+|\-)?\s*\d\d\d\d?/),e.timezone)),d.zz=c.cache(c.process(c.rtoken(/^(\+|\-)\s*\d\d\d\d/),e.timezone)),d.zzz=c.cache(c.process(d.ctoken2("timezone"),e.timezone)),d.timeSuffix=c.each(c.ignore(d.whiteSpace),c.set([d.tt,d.zzz])),d.time=c.each(c.optional(c.ignore(c.stoken("T"))),d.hms,d.timeSuffix),d.d=c.cache(c.process(c.each(c.rtoken(/^([0-2]\d|3[0-1]|\d)/),c.optional(d.ctoken2("ordinalSuffix"))),e.day)),d.dd=c.cache(c.process(c.each(c.rtoken(/^([0-2]\d|3[0-1])/),c.optional(d.ctoken2("ordinalSuffix"))),e.day)),d.ddd=d.dddd=c.cache(c.process(d.ctoken("sun mon tue wed thu fri sat"),function(a){return function(){this.weekday=a}})),d.M=c.cache(c.process(c.rtoken(/^(1[0-2]|0\d|\d)/),e.month)),d.MM=c.cache(c.process(c.rtoken(/^(1[0-2]|0\d)/),e.month)),d.MMM=d.MMMM=c.cache(c.process(d.ctoken("jan feb mar apr may jun jul aug sep oct nov dec"),e.month)),d.y=c.cache(c.process(c.rtoken(/^(\d\d?)/),e.year)),d.yy=c.cache(c.process(c.rtoken(/^(\d\d)/),e.year)),d.yyy=c.cache(c.process(c.rtoken(/^(\d\d?\d?\d?)/),e.year)),d.yyyy=c.cache(c.process(c.rtoken(/^(\d\d\d\d)/),e.year)),b=function(){return c.each(c.any.apply(null,arguments),c.not(d.ctoken2("timeContext")))},d.day=b(d.d,d.dd),d.month=b(d.M,d.MMM),d.year=b(d.yyyy,d.yy),d.orientation=c.process(d.ctoken("past future"),function(a){return function(){this.orient=a}}),d.operator=c.process(d.ctoken("add subtract"),function(a){return function(){this.operator=a}}),d.rday=c.process(d.ctoken("yesterday tomorrow today now"),e.rday),d.unit=c.process(d.ctoken("minute hour day week month year"),function(a){return function(){this.unit=a}}),d.value=c.process(c.rtoken(/^\d\d?(st|nd|rd|th)?/),function(a){return function(){this.value=a.replace(/\D/g,"")}}),d.expression=c.set([d.rday,d.operator,d.value,d.unit,d.orientation,d.ddd,d.MMM]),b=function(){return c.set(arguments,d.datePartDelimiter)},d.mdy=b(d.ddd,d.month,d.day,d.year),d.ymd=b(d.ddd,d.year,d.month,d.day),d.dmy=b(d.ddd,d.day,d.month,d.year),d.date=function(a){return(d[Date.CultureInfo.dateElementOrder]||d.mdy).call(this,a)},d.format=c.process(c.many(c.any(c.process(c.rtoken(/^(dd?d?d?|MM?M?M?|yy?y?y?|hh?|HH?|mm?|ss?|tt?|zz?z?)/),function(a){if(d[a])return d[a];throw Date.Parsing.Exception(a)}),c.process(c.rtoken(/^[^dMyhHmstz]+/),function(a){return c.ignore(c.stoken(a))}))),function(a){return c.process(c.each.apply(null,a),e.finishExact)});var g={},h=function(a){return g[a]=g[a]||d.format(a)[0]};d.formats=function(a){if(a instanceof Array){for(var b=[],d=0;d<a.length;d++)b.push(h(a[d]));return c.any.apply(null,b)}return h(a)},d._formats=d.formats(["yyyy-MM-ddTHH:mm:ss","ddd, MMM dd, yyyy H:mm:ss tt","ddd MMM d yyyy HH:mm:ss zzz","d"]),d._start=c.process(c.set([d.date,d.time,d.expression],d.generalDelimiter,d.whiteSpace),e.finish),d.start=function(a){try{var b=d._formats.call({},a);if(0===b[1].length)return b}catch(c){}return d._start.call({},a)}}(),Date._parse=Date.parse,Date.parse=function(a){var b=null;if(!a)return null;try{b=Date.Grammar.start.call({},a)}catch(c){return null}return 0===b[1].length?b[0]:null},Date.getParseFunction=function(a){var b=Date.Grammar.formats(a);return function(a){var c=null;try{c=b.call({},a)}catch(d){return null}return 0===c[1].length?c[0]:null}},Date.parseExact=function(a,b){return Date.getParseFunction(b)(a)};var app=angular.module("app",["ngRoute","appControllers","appDirectives","angularFileUpload","minicolors"]);app.service("config",["host",function(){return{serv:{user:{ping:"dev/ping.js"},urn_serv:{base:"urn:cite:perseus:"},prefix:{}},xhr:{sparql:{url:"http://localhost:4321/ds/query"},json:{url:"http://localhost:4567"},tmpl:{url:"http://localhost:4567/apps/imgcollect/json_ld"}},imgup:{url:"http://localhost:1234"},ontology:{imgViewer:{term:"imageViewer",ns:"http://data.perseus.org/rdfvocab/cite/",prefix:"citex"},imgServer:{term:"imageServer",ns:"http://data.perseus.org/rdfvocab/cite/",prefix:"citex"},label:{term:"label",ns:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",prefix:"rdf"},description:{term:"description",ns:"http://www.w3.org/1999/02/22-rdf-syntax-ns#",prefix:"rdf"},type:{term:"type",ns:"http://purl.org/dc/terms/",prefix:"dct"},src:{term:"references",ns:"http://purl.org/dc/terms/",prefix:"dct"},orig:{term:"orig",ns:"https://github.com/PerseusDL/CITE-JSON-LD/blob/master/templates/img/SCHEMA.md#",prefix:"this"},owner:{term:"publisher",ns:"http://purl.org/dc/terms/",prefix:"dct"},creator:{term:"creator",ns:"http://purl.org/dc/terms/",prefix:"dct"},identifier:{term:"dct:identifier",ns:"http://purl.org/dc/terms/",prefix:"dct"},contributor:{term:"contributor",ns:"http://purl.org/dc/terms/",prefix:"dct"},created:{term:"created",ns:"http://purl.org/dc/terms/",prefix:"dct"},modified:{term:"modified",ns:"http://purl.org/dc/terms/",prefix:"dct"},width:{term:"width",ns:"https://github.com/PerseusDL/CITE-JSON-LD/blob/master/templates/img/SCHEMA.md#",prefix:"this"},height:{term:"height",ns:"https://github.com/PerseusDL/CITE-JSON-LD/blob/master/templates/img/SCHEMA.md#",prefix:"this"},x:{term:"x",ns:"https://github.com/PerseusDL/CITE-JSON-LD/blob/master/templates/img/SCHEMA.md#",prefix:"this"},y:{term:"y",ns:"https://github.com/PerseusDL/CITE-JSON-LD/blob/master/templates/img/SCHEMA.md#",prefix:"this"},subject:{term:"subject",ns:"http://purl.org/dc/terms/",prefix:"dct"},memberOf:{term:"belongsTo",ns:"http://www.homermultitext.org/cite/rdf/",prefix:"cite"},represents:{term:"P138_represents",ns:"http://www.cidoc-crm.org/cidoc-crm/",prefix:"crm"},rights:{term:"license",ns:"http://www.homermultitext.org/cite/rdf/",prefix:"cite",default_value:"http://creativecommons.org/licenses/by-nc-sa/4.0/"}},access:{public_views:["/view"],logged_in:"/upload",logged_out:"/login"}}}]),app.service("host",[function(){return{url:location.protocol+"//"+location.hostname+(location.port?":"+location.port:"")}}]),app.config(["$routeProvider",function(a){a.when("/uploads",{templateUrl:"html/upload/list.html",controller:"UploadListCtrl"}).when("/uploads/:page",{templateUrl:"html/upload/list.html",controller:"UploadListCtrl"}).when("/upload/:urn",{templateUrl:"html/upload/edit.html",controller:"UploadCtrl"}).when("/new/upload",{templateUrl:"html/upload/new.html",controller:"UploadNew"}).when("/new_2/upload",{templateUrl:"html/upload/new_2.html",controller:"UploadNew2"}).otherwise({redirectTo:"/uploads"}),a.when("/items",{templateUrl:"html/item/list.html",controller:"ItemListCtrl"}).when("/items/:page",{templateUrl:"html/item/list.html",controller:"ItemListCtrl"}).when("/item/:urn",{templateUrl:"html/item/edit.html",controller:"ItemCtrl"}).when("/new/item/:urn",{templateUrl:"html/item/new.html",controller:"ItemNew"}),a.when("/collections",{templateUrl:"html/collection/list.html",controller:"CollectionListCtrl"}).when("/collections/:page",{templateUrl:"html/collection/list.html",controller:"CollectionListCtrl"}).when("/collection/:urn",{templateUrl:"html/collection/edit.html",controller:"CollectionCtrl"}).when("/new/collection",{templateUrl:"html/collection/new.html",controller:"CollectionNew"}),a.when("/roi/search",{templateUrl:"html/roi/search.html",controller:"RoiSearch"}),a.when("/resize/:urn",{templateUrl:"html/resize.html",controller:"ResizeCtrl"}),a.when("/login",{templateUrl:"html/login.html",controller:"LoginCtrl"}),a.when("/view/:urn",{templateUrl:"html/view.html",controller:"ViewCtrl"}),a.when("/delete/:urn",{templateUrl:"html/delete.html",controller:"DeleteCtrl"}).when("/delete",{templateUrl:"html/pre_delete.html",controller:"PreDeleteCtrl"}),a.when("/imgspect/:urn",{templateUrl:"html/imgspect.html",controller:"imgspect"})
}]).run(["$rootScope","$location","user","config",function(a,b,c,d){function e(){for(var a=b.path(),c=d.access.public_views,e=0;e<c.length;e++)if(0==a.indexOf(c[e]))return!0}function f(){var a=b.path();0==a.indexOf(d.access.logged_out)&&b.path(d.access.logged_in)}a.$on("$routeChangeSuccess",function(){c.check().then(function(){f(),a.$emit(c.events.ok)},function(){1!=e()&&(a.$emit(c.events.error),b.path(d.access.logged_out))})})}]);var appControllers=angular.module("appControllers",[]);appControllers.controller("AnnotationListCtrl",["$scope","$injector","user","$rootScope","onto",function(a,b,c,d,e){function f(){a.type="annotation",a.title="Annotation List",a.keys=["urn","label","desc","user","time"];var c=e.pre("label"),d=e.pre("description");b.invoke(ListCtrl,this,{$scope:a}),a.init([c,d]),a.filter={},a.filter[c]=null,a.filter[d]=null,a.apply_filter=function(){b.invoke(ListCtrl,this,{$scope:a}),a.init([c,d])}}d.$on(c.events.ok,function(){f()})}]),appControllers.controller("CollectionCtrl",["$scope","$injector","user","$rootScope","onto","collection",function(a,b,c,d,e,f){function g(){b.invoke(EditCtrl,this,{$scope:a}),a.init([h,i,l,k]),f.items(a.urn).then(function(b){a.items=b})}a.title="Collection",a.keys=["urn","label","desc","user","time"];var h=e.pre("label"),i=e.pre("description"),j=e.pre("subject"),k=e.pre("imgViewer"),l=e.pre("imgServer");a.form={},a.form[h]="",a.form[i]="",a.form[j]=[],a.form[l]="",a.form[k]="",d.$on(c.events.ok,function(){g()})}]),appControllers.controller("CollectionListCtrl",["$scope","$injector","$rootScope","$routeParams","user","onto","query",function(a,b,c,d,e,f,g){function h(){return e.only?["?urn","creator","<"+e.url()+">"]:null}function i(b,c){var d=a.filter[c];return angular.copy(null==d?{optional:!0}:{filter:"regex( "+b+', "'+d+'", "i" )'})}a.type="collection",a.keys=["urn","label","desc","user","time"],a.limit=10,a.page=void 0==d.page?1:parseInt(d.page);var j=f.pre("label"),k=f.pre("description");a.filter={},a.filter[j]=null,a.filter[k]=null,a.query=function(){return{where:[["?urn","type",'"collection"'],h(),["?urn","label","?label",i("?label",j)],["?urn","description","?desc",i("?desc",k)],["?urn","created","?time",{optional:!0}],["?urn","represents","?rep",{optional:!0}],["?urn","creator","?user",{optional:!0}]],order_by:"desc( ?time )",limit:a.limit,offset:a.limit*(a.page-1)}},c.$on(e.events.ok,function(){a.apply_filter()}),a.clear_filter=function(){for(var b in a.filter)a.filter[b]=null;a.apply_filter()},a.$watch(function(){return e.only},function(b,c){b!=c&&a.apply_filter()}),a.apply_filter=function(){g.count(a.query()).then(function(b){a.count=b,a.pages=Math.ceil(a.count/a.limit),a.prev=a.page>1?!0:!1,a.next=a.page<a.pages?!0:!1}),g.get(a.query()).then(function(b){a.json=b})}}]),appControllers.controller("CollectionNew",["$scope","$injector","urnServ","$rootScope","user","onto",function(a,b,c,d,e,f){function g(){b.invoke(NewCtrl,this,{$scope:a}),a.init([h,i])}a.title="Collection New",a.type="collection",a.show_uniq=!0,a.error=!1;var h=f.pre("label"),i=f.pre("description");a.form={},a.form[h]=f.default_value("label"),a.form[i]=f.default_value("description"),d.$on(e.events.ok,function(){g()}),a.urn_uniq=function(){c.uniq(a.urn,j)};var j=function(b,c){return a.show_uniq=!b,a.show_error=!b,1==b?void a.claim(c):void(a.stdout+="That URN is taken. Choose another.")}}]),appControllers.controller("DeleteCtrl",["$scope","$injector","json","$routeParams","deleter",function(a,b,c,d,e){function f(){c.urn(a.urn).then(function(b){"error"in b&&(a.urn_invalid=!0)})}a.urn=void 0==d.urn?null:d.urn,a.refs=[],a.urn_invalid=!1,a.deleted=!1,a.ref_checked=!1,a.ui_no_record=function(){return a.urn_invalid},a.ui_success=function(){return a.deleted},a.ui_delete_safe=function(){return a.ref_checked&&0==a.deleted&&0==a.refs.length?!0:void 0},a.ui_ref_found=function(){return a.ref_checked&&0==a.deleted&&a.refs.length>0?!0:void 0},a.ui_ref_check=function(){return 0==a.ref_checked&&0==a.deleted&&0==a.urn_invalid?!0:void 0},a.ui_ref_table=function(){return a.refs.length>0&&0==a.deleted?!0:void 0},a.ui_del_button=function(){return 0==a.urn_invalid&&0==a.deleted&&a.ref_checked?!0:void 0},f(),a.get_refs=function(){e.refs(a.urn).then(function(b){a.refs=b,a.ref_checked=!0})},a["delete"]=function(){e.urn(a.urn).then(function(){a.deleted=!0})}}]),appControllers.controller("imgspect",["$scope","$injector","$routeParams","json","item","onto","tmpl","cropper",function(a,b,c,d,e,f,g,h){function i(b){return a.urn+"@"+[b.x,b.y,b.width,b.height].join(",")}function j(b){var c=angular.copy(a["default"]);b=angular.extend(c,b),b["@id"]=i(b),b["cite:belongsTo"]={"@id":a.urn},b["rdf:label"]=b.label,b["rdf:description"]=b.description,d.post("roi/"+b["@id"],b).then(function(a){console.log(a)},function(a){console.log(a)}),h.add(b["@id"])}function k(){return a.json.annotations}function l(b){d.urn(b).then(function(b){var c=b.src[0];d.get(c).then(function(b){a.json.upload=b,m(a.urn)})})}function m(b){e.rois(b).then(function(b){a.json.annotations=b}),n()}function n(){a.src=a.json.upload["dct:references"]["@id"],o()}function o(){N.load(function(){W.width=this.width,W.height=this.height,C(),N.detach(),M()})}function p(a){return a.originalEvent.srcElement==P[0]?!0:!1}function q(){return{x:null,y:null,w:null,h:null}}function r(){Z({x:s(),y:t()}),ab({x:u(),y:v()})}function s(){return Math.min(Z().x,ab().x)}function t(){return Math.min(Z().y,ab().y)}function u(){return Math.max(Z().x,ab().x)}function v(){return Math.max(Z().y,ab().y)}function w(){R.on("touchstart click",function(){a.lite_stash()}),S.on("touchstart click",function(){a.lite_cancel()})}function x(a,b){return{x:a.x-b.x,y:a.y-b.y}}function y(a,b){return{x:a.x+b.x,y:a.y+b.y}}function z(){T.on("touchstart mousedown",function(a){cb=x(J(a),Z())}).on("touchend mouseup",function(){cb=bb()})}function A(){return null==cb.x&&null==cb.y?!1:!0}function B(){P.on("touchstart mousedown",function(a){p(a)?G(a):null}).on("touchmove mousemove",function(a){H(a)}).on("touchend mouseup",function(a){I(a)})}function C(){K(),B(),z(),w()}function D(a){ab(J(a)),E()}function E(){a.temp_lite.x=s().toFixed(4),a.temp_lite.y=t().toFixed(4),a.temp_lite.w=(u()-a.temp_lite.x).toFixed(4),a.temp_lite.h=(v()-a.temp_lite.y).toFixed(4)}function F(a){var b=J(a),c=x(ab(),Z());Z(x(b,cb)),ab(y(Z(),c)),E()}function G(a){Z(J(a))}function H(b){X&&(A()?F(b):D(b),a.refresh())}function I(){r()}function J(b){var c=P.offset(),d=b.clientX-c.left,e=b.clientY-c.top+$(document).scrollTop();return{x:d/a.canvas_w,y:e/a.canvas_h}}function K(){Q.draggable({containment:"parent",scroll:!1,drag:function(){M()},stop:function(){}})}function L(){var b=Q.position(),c=b.left/a.nav_scale(),d=b.top/a.nav_scale();a.canvas_x=-1*c*a.zoom,a.canvas_y=-1*d*a.zoom,a.refresh()}function M(){a.canvas_w=W.width*a.zoom,a.canvas_h=W.height*a.zoom,L()}var N=$(".imgspect img"),O=$(".imgspect.frame"),P=$(".imgspect.frame .canvas"),Q=($(".imgspect.nav"),$(".imgspect.nav .drag")),R=($(".imgspect.frame .canvas .lite.temp .resize"),$(".imgspect.frame .canvas .lite.temp .add")),S=$(".imgspect.frame .canvas .lite.temp .cancel"),T=$(".imgspect.frame .canvas .lite.temp .nudge"),U=$(".imgspect.frame .canvas .annot");a.urn=void 0==c.urn?null:c.urn,a.json={};var V=!1;a.popout=function(a){return V=void 0==a?V:a},a.config={zoom:{max:5},lite:{color:"#FF0",opa:.75},nav:{opa:.5,pos:"right"},annot:{color:"#F2F2F2",opa:.9,input:{color:"#FDFDFD"}},color_picker:{show:null,showSpeed:100}};var W={};a.lite_opa_chg=function(b){a.config.lite.opa=b,a.$apply()},a.frame_w=function(){return O.width()},a.frame_h=600,a.canvas_w=0,a.canvas_h=0,a.canvas_x=0,a.canvas_y=0,a.zoom=1,a.zoom_chg=function(b){var c=a.config.zoom.max,d=b*c;a.zoom=d.toPrecision(2),M()},a.calc_offset=function(b){var c=a.frame_x_rel(parseFloat(a.temp_lite.x)+parseFloat(.5*a.temp_lite.w)),d=a.frame_y_rel(parseFloat(a.temp_lite.y)+parseFloat(a.temp_lite.h));switch(b){case"x":return c>.75?-1*U.outerWidth():0;case"y":return c>.75?0:.75>d?a.to_canvas_y(a.temp_lite.h):-1*U.outerHeight()}},a.wr=function(){var b=a.frame_w()/a.canvas_w;return b=b>1?1:b},a.hr=function(){var b=a.frame_h/a.canvas_h;return b=b>1?1:b},a.drag_x=0,a.drag_y=0,a.drag_w=function(){return a.nav_w()*a.wr()},a.drag_h=function(){return a.nav_h*a.hr()},a.nav_h=300,a.nav_w=function(){return a.nav_scale()*W.width},a.nav_scale=function(){return a.nav_h/W.height},a.nav_right=!0,a["default"]=null,g.get("roi").then(function(b){a["default"]=b},function(){console.log("error")}),a.add=function(){var b={label:a.temp_label,description:a.temp_desc,height:a.temp_lite.h,width:a.temp_lite.w,x:a.temp_lite.x,y:a.temp_lite.y},c=k();c.push(b),a.popout(!1),a.lite_reset()},a.save=function(){for(var a=k(),b=0;b<a.length;b++)"urn"in a[b]||j(a[b])},d.urn(a.urn).then(function(b){var c=b.src[0],e=f.pre("src");d.get(c).then(function(b){a.json.item=b,l(b[e]["@id"])})}),a.to_canvas_x=function(b){return b*a.canvas_w},a.to_canvas_y=function(b){return b*a.canvas_h},a.to_nav_x=function(b){return b*a.nav_w()},a.to_nav_y=function(b){return b*a.nav_h},a.frame_x_rel=function(b){var c=a.to_canvas_x(b);return(c-a.canvas_x)/a.frame_w()},a.frame_y_rel=function(b){var c=a.to_canvas_y(b);return(c+a.canvas_y)/a.frame_h};var X=!1;$(document).on("touchstart mousedown",function(){X=!0}).on("touchend mouseup",function(){X=!1}),a.temp_lite=q(),a.lite_reset=function(){a.temp_lite=q()},a.lite_cancel=function(){a.lite_reset(),a.refresh()},a.lite_clear_text=function(){a.temp_label="",a.temp_desc=""},a.lite_clear_text(),a.lites=[],a.lite_stash=function(){a.lites.push(angular.copy(a.temp_lite))};var Y={x:null,y:null},Z=function(a){return angular.isDefined(a)?(Y.x=a.x,void(Y.y=a.y)):Y},_={x:null,y:null},ab=function(a){return angular.isDefined(a)?(_.x=a.x,void(_.y=a.y)):_},bb=function(){return{x:null,y:null}},cb=bb();a.refresh=function(){a.$digest()}}]),appControllers.controller("ItemCtrl",["$scope","$injector","onto","item",function(a,b,c,d){a.title="Item";var e=c.pre("label"),f=c.pre("description"),g=c.pre("represents"),h=c.pre("rights"),i=c.pre("subject");a.form={},a.form[e]="",a.form[f]="",a.form[g]="",a.form[h]="",a.form[i]=[],b.invoke(EditCtrl,this,{$scope:a}),a.init([e,f,g,h]);var j={};j.urn=a.urn.substring(0,a.urn.indexOf(".")),a.collections=[],a.collections[0]=j;d.rois(a.urn).then(function(b){a.rois=b}),d.thumb(a.urn).then(function(b){a.upload=b}),d.upload_src(a.urn).then(function(b){a.img_src=b[0].img})}]),appControllers.controller("ItemListCtrl",["$scope","$injector","$rootScope","$routeParams","user","onto","query",function(a,b,c,d,e,f,g){function h(){return e.only?["?urn","creator","<"+e.url()+">"]:null}function i(b,c){var d=a.filter[c];return angular.copy(null==d?{optional:!0}:{filter:"regex( "+b+', "'+d+'", "i" )'})}a.type="item",a.keys=["urn","label","desc","rep","user","time"],a.limit=10,a.page=void 0==d.page?1:parseInt(d.page);var j=f.pre("label"),k=f.pre("description"),l=f.pre("represents");a.filter={},a.filter[j]=null,a.filter[k]=null,a.filter[l]=null,a.query=function(){return{where:[["?urn","type",'"item"'],h(),["?urn","label","?label",i("?label",j)],["?urn","description","?desc",i("?desc",k)],["?urn","represents","?rep",i("?rep",l)],[["?urn","src","?up"],["?res","memberOf","?up"],["?res","src","?thumb"],{optional:!0}],["?urn","created","?time",{optional:!0}],["?urn","creator","?user",{optional:!0}]],order_by:"desc( ?time )",limit:a.limit,offset:a.limit*(a.page-1)}},c.$on(e.events.ok,function(){a.apply_filter()}),a.clear_filter=function(){for(var b in a.filter)a.filter[b]=null;a.apply_filter()},a.$watch(function(){return e.only},function(b,c){b!=c&&a.apply_filter()}),a.apply_filter=function(){g.count(a.query()).then(function(b){a.count=b,a.pages=Math.ceil(a.count/a.limit),a.prev=a.page>1?!0:!1,a.next=a.page<a.pages?!0:!1}),g.get(a.query()).then(function(b){a.json=b})}}]),appControllers.controller("ItemNew",["$scope","urnServ","$routeParams","collection","$location","json","stdout","user","$injector","onto","tmpl",function(a,b,c,d,e,f,g,h,i,j,k){a.upload_urn=void 0==c.urn?null:c.urn,a.type="item",a.title="Item New",a.urn=null,a.ready=!1,a.collection=null,a.form={},a.user_collections=null,a.add_to=function(c){a.collection=c,b.fresh(c+".{{ id }}",l)},d.mine().then(function(b){a.user_collections=b}),a.search=function(){var b=a.form.search;a.collections=[],d.search(b).then(function(b){a.collections=b})};var l=function(b){a.urn=b,a.ready=!0};a.create_item=function(){o()},a.data_path=function(b){return a.type+"/"+b};var m=function(){n().then(function(){f.post(a.data_path(a.urn),a.json).then(function(){e.path("item/"+a.urn)})})},n=function(){return f.urn(a.upload_urn).then(function(b){return f.get(b.src[0]).then(function(b){var c=j.pre("src"),d=j.pre("creator"),e=j.pre("memberOf"),f=j.pre("created"),g=j.pre("rights"),i=j.pre("label"),k=j.pre("description");a.json["@id"]=a.urn,a.json[c]["@id"]=a.upload_urn,a.json[d]["@id"]=h.id(),a.json[e]["@id"]=a.collection,a.json[f]=(new TimeStamp).xsd(),a.json[i]=b[i],a.json[k]=b[k],a.json[g]["@id"]=j.default_value("rights")})})},o=function(){k.get(a.type).then(function(b){a.json=b,g.log("Default "+a.type+" JSON loaded"),m()})}}]),appControllers.controller("JsonMsg",["$scope","json",function(a,b){var c=function(c,d,e,f){switch(a.method=c,a.url=d,a.status=e,a.msg=f,a.hide=!1,a.status){case b.state().success:a.mode="success";break;case b.state().error:a.mode="alert";break;default:a.mode="secondary"}};b.on_change(c)}]),appControllers.controller("LoginCtrl",["$scope","user",function(){}]);var EditCtrl=["$scope","json","$routeParams","onto",function(a,b,c,d){function e(b){b in a.json&&(angular.isDefined(a.json[b]["@id"])?a.json[b]["@id"]=a.form[b]:a.json[b]=a.form[b],k(a.json))}function f(){for(var b in a.json)b in a.form&&(a.form[b]=angular.isDefined(a.json[b]["@id"])?a.json[b]["@id"]:a.json[b])}function g(){a.saving=!0,b.put(a.src[0],a.json).then(function(b){h(b),setTimeout(function(){a.saving=!1},5e3)})}function h(b){a.stdout+=b+"\n"}function i(){b.urn(a.urn).then(function(b){a.src=b.src,j()})}function j(){b.get(a.src[0]).then(function(b){a.json=b,k(a.json),f(),void 0!=a.run&&a.run()})}function k(c){var d=b.disp(c);a.context=d[0],a.json_string=d[1]}function l(b){i(),a.edit_text_fields=b}a.urn=void 0==c.urn?null:c.urn,a.stdout="",a.context=null,a.src=null,a.json={},a.json_string="",a.upload_ref=d.pre("src"),a.save=function(){g()},a.change=function(a){e(a)},a.init=function(a){l(a)}}],NewCtrl=["$scope","urnServ","json","stdout","user","onto","tmpl",function(a,b,c,d,e,f,g){function h(b){a.edit_text_fields=b}a.json={},a.ready=!1,a.id=null,a.urn="",a.base_urn=b.base,a.urn_build=function(){a.urn=a.base_urn+a.clean_id()},a.clean_id=function(){return a.id.alphaOnly().toLowerCase()},a.init=function(a){h(a)},a.stdout="",a.claim=function(c){b.claim(a.data_path(c),c).then(function(a){d.log(a),k()})},a.data_path=function(b){return a.type+"/"+b};var i=function(){j(),c.put(a.data_path(a.urn),a.json).then(function(b){d.log(b),a.ready=!0})},j=function(){a.json["@id"]=a.urn;var b=f.pre("creator"),c=f.pre("created");a.json[b]["@id"]=e.id(),a.json[c]=(new TimeStamp).xsd()},k=function(){g.get(a.type).then(function(b){a.json=b,d.log("Default "+a.type+" JSON loaded"),i()})}}];appControllers.controller("PreDeleteCtrl",["$scope","$window",function(a,b){a.urn=null,a.go=function(){b.location.href="#/delete/"+a.urn}}]),appControllers.controller("ResizeCtrl",["$scope","$injector","user","$rootScope","onto",function(a,b,c,d,e){function f(){{var c=e.pre("label"),d=e.pre("description");e.pre("subject")}a.title="Resize",a.form={},a.form[c]="",a.form[d]="",a.form[subject]=[],b.invoke(EditCtrl,this,{$scope:a}),a.run=function(){a.uploads=[],a.uploads[0]={urn:a.json[e.pre("src")]["@id"]}},a.init()}d.$on(c.events.ok,function(){f()})}]),appControllers.controller("RoiSearch",["$scope","user","roi",function(a,b,c){a.search_for=null,a.search=function(){c.by_label(a.search_for).then(function(b){a.rois=b})}}]),appControllers.controller("SparqlMsg",["$scope","sparql",function(a,b){a.query="";var c=function(b,c){a.query=c};b.on_change(c)}]),appControllers.controller("StdOut",["$scope","stdout",function(a,b){a.stdout=b,a.$watch("stdout.msg",function(){a.msg=b.msg})}]),appControllers.controller("UploadCtrl",["$scope","$injector","resize","item","onto",function(a,b,c,d,e){a.title="Upload";var f=e.pre("label"),g=e.pre("description"),h=e.pre("subject"),i=e.pre("rights"),j=e.pre("owner");a.form={},a.form[f]=null,a.form[g]=null,a.form[j]=null,a.form[i]=e.default_value("rights"),a.form[h]=[],b.invoke(EditCtrl,this,{$scope:a}),a.init([f,g,j,i]),a.resize=[],c.get(a.urn).then(function(b){a.resize=b}),a.items=[],d.by_upload(a.urn).then(function(b){a.items=b})}]),appControllers.controller("UploadListCtrl",["$scope","$injector","$rootScope","$routeParams","user","onto","query",function(a,b,c,d,e,f,g){function h(){return e.only?["?urn","creator","<"+e.url()+">"]:null}function i(b,c){var d=a.filter[c];return angular.copy(null==d?{optional:!0}:{filter:"regex( "+b+', "'+d+'", "i" )'})}a.type="upload",a.keys=["urn","label","desc","user","time"],a.limit=10,a.page=void 0==d.page?1:parseInt(d.page);var j=f.pre("label"),k=f.pre("description");a.filter={},a.filter[j]=null,a.filter[k]=null,a.query=function(){return{where:[["?urn","type",'"upload"'],h(),["?urn","label","?label",i("?label",j)],["?urn","description","?desc",i("?desc",k)],[["?res","memberOf","?urn"],["?res","src","?thumb"],{optional:!0}],["?urn","created","?time",{optional:!0}],["?urn","represents","?rep",{optional:!0}],["?urn","creator","?user",{optional:!0}]],order_by:"desc( ?time )",limit:a.limit,offset:a.limit*(a.page-1)}},c.$on(e.events.ok,function(){a.apply_filter()}),a.clear_filter=function(){for(var b in a.filter)a.filter[b]=null;a.apply_filter()},a.$watch(function(){return e.only},function(b,c){b!=c&&a.apply_filter()}),a.apply_filter=function(){g.count(a.query()).then(function(b){a.count=b,a.pages=Math.ceil(a.count/a.limit),a.prev=a.page>1?!0:!1,a.next=a.page<a.pages?!0:!1}),g.get(a.query()).then(function(b){a.json=b})}}]),appControllers.controller("UploadNew",["$scope","$injector","urnServ","json","stdout","user","$upload","config","$http","onto","resizer","tmpl",function(a,b,c,d,e,f,g,h,i,j,k,l){function m(b,c){a.form[b]=j.default_value(c),a.change(b)}function n(){var b=j.pre("creator"),c=j.pre("created");a.json["@id"]=a.urn,a.json[b]["@id"]=f.id(),a.json[c]=(new TimeStamp).xsd(),p(a.json)}function o(b){b in a.json&&(angular.isDefined(a.json[b]["@id"])?a.json[b]["@id"]=a.form[b]:a.json[b]=a.form[b],p(a.json))}function p(b){var c=d.disp(b);a.context=c[0],a.json_string=c[1]}function q(){l.get(a.type).then(function(b){a.json=b,p(a.json),e.log("Default "+a.type+" JSON loaded"),a.ready=!0,m(w,"rights")})}function r(b){a.upload_out="Uploaded successfully",s(b),a.json[j.pre("src")]["@id"]=b.src.replace(" ","%20"),a.json[j.pre("orig")]=b.orig,p(a.json),c.fresh(c.base+"upload.{{ id }}",y)}function s(b){var c=b.exif;for(var d in c)a.json["exif:"+d.toCamel()]=c[d]}a.title="Upload New",a.stdout="";var t=j.pre("label"),u=j.pre("description"),v=j.pre("src"),w=j.pre("rights"),x=j.pre("owner");a.form={},a.form[t]="",a.form[u]="",a.form[x]="",a.form[w]="",a.form[v]="",a.src_field=v,a.type="upload",b.invoke(NewCtrl,this,{$scope:a}),a.init([t,u,w,x]),a.saving=!1,a.show_disk=!1,a.disk=function(b){a.show_disk=b},a.change=function(a){o(a)},a.save=function(){a.saving=!0,1==a.show_disk?a.file&&a.upload():a.form[v]&&a.cp_http()},q(),a.file="",a.upload_out=!1,a.upload=function(){g.upload({url:h.imgup.url+"/upload",method:"POST",file:a.file}).error(function(){a.upload_out="There was an error upload"}).success(function(a){r(a)})},a.cp_http=function(){i({method:"POST",url:h.imgup.url+"/upload",headers:{"Content-Type":"application/json"},data:{src:a.form[v]}}).error(function(){a.upload_out="There was an error upload"}).success(function(a){r(a)})};var y=function(b){a.urn=b,n(),d.post(a.data_path(a.urn),a.json).then(function(){setTimeout(function(){a.saving=!1},5e3),k.add(a.urn,200,200)})}}]),appControllers.controller("UploadNew2",["$scope","config","json","tmpl","resizer","$upload","onto","urnServ","user","resizer",function(a,b,c,d,e,f,g,h,i,e){function j(){d.get(a.type).then(function(b){a.json=b,a.tmpl.loaded=!0}),function(b){a.tmpl.error=b}}function k(){a.json["@id"]=a.urn;var b=g.pre("creator"),c=g.pre("created"),d=g.pre("orig");a.json[b]["@id"]=i.id(),a.json[c]=(new TimeStamp).xsd(),a.json[q]["@id"]=a.progress.src.replace(" ","%20"),a.json[d]=a.progress.orig}a.type="upload",a.progress={total:null,now:null,done:!1,error:!1},a["default"]=angular.copy(a.progress);var l=$("#progressbar"),m=$(".progress-label");a.upload=function(){a.progress=angular.copy(a["default"]),l.progressbar({value:!1,change:function(){m.text(l.progressbar("value")+"%")}}),f.upload({url:b.imgup.url+"/upload",method:"POST",file:a.file}).progress(function(b){a.progress.total=b.total,a.progress.now=b.loaded,l.progressbar("value",b.loaded/b.total*100)}).error(function(b){a.progress.error=!0,a.error_output=c.disp(b)}).success(function(b){a.progress.orig=b.orig,a.progress.src=b.src,a.progress.done=!0,h.fresh(h.base+"upload.{{ id }}",n)})};var n=function(b){a.urn=b,j()};a.tmpl={loaded:null,error:null,saving:!1,saved:!1};var o=g.pre("label"),p=g.pre("description"),q=g.pre("src"),r=g.pre("rights"),s=g.pre("owner");a.form={},a.form[o]="",a.form[p]="",a.form[s]="",a.form[r]="",a.form[q]="",a.src_field=q,a.edit_fields=[o,p,r,s],a.change=function(b){b in a.json&&(angular.isDefined(a.json[b]["@id"])?a.json[b]["@id"]=a.form[b]:a.json[b]=a.form[b])},a.data_path=function(b){return a.type+"/"+b},a.save=function(){a.tmpl.saving=!0,k(),c.post(a.data_path(a.urn),a.json).then(function(b){"error"in b?(a.tmpl.error=b,a.error_out=c.disp(a.json)):(a.tmpl.saved=!0,e.add(a.urn,200,200))})}}]),appControllers.controller("urnServ",["$scope","urnServ",function(){}]),appControllers.controller("UserCtrl",["$scope","$injector","user","$rootScope",function(a,b,c,d){function e(){a.only=c.only,a.user=c.id(),a.username=c.name()}d.$on(c.events.ok,function(){e()}),a["switch"]=function(a){c.only=a,e()}}]),appControllers.controller("ViewCtrl",["$scope","$routeParams","json",function(a,b,c){function d(a){c.urn(a).then(function(a){f(a.src[0])})}function e(b){var c=b["dct:type"];switch(c){case"upload":a.src=b["dct:references"]["@id"];break;case"item":d(b["dct:references"]["@id"])}}function f(a){c.get(a).then(function(a){e(a)})}a.urn=void 0==b.urn?null:b.urn;var g=a.urn.split("@");g.length>1?(a.coords=g[1].split(","),d(g[0])):d(g),a.max_width=600}]);var appDirectives=angular.module("appDirectives",[]);appDirectives.directive("imgBit",function(){return{link:function(a,b,c){b.bind("load",function(){b.wrap('<div class="frame">');var a=b.parent();a.wrap('<div class="img-bit">');var d=b.parent(),e=this.naturalHeight,f=this.naturalWidth,g=c.ngParam.split(",");d.css({display:"inline-block"}),a.css({width:parseInt(f*g[2]),height:parseInt(e*g[3]),position:"relative",overflow:"hidden"}),b.css({position:"absolute",display:"block","vertical-align":"baseline","max-width":"none","max-height":"none",width:f,height:e,top:parseInt(g[1]*e*-1),left:parseInt(g[0]*f*-1)})})}}}),appDirectives.directive("imgLoc",function(){return{link:function(a,b,c){b.bind("load",function(){var a=c.ngParam.split(","),d=this.naturalHeight,e=this.naturalWidth,f=a[4],g=f/e;1>g&&(e=f,d*=g),b.wrap('<div class="img-loc">');var h=b.parent();h.css({width:parseInt(e),height:parseInt(d),position:"relative",overflow:"hidden"}),b.css({width:parseInt(e),height:parseInt(d)}),h.append('<div class="lite">');var i=b.next();i.css({position:"absolute",left:parseInt(e*a[0]),top:parseInt(d*a[1]),width:parseInt(e*a[2]),height:parseInt(d*a[3])}),h.after('<div class="clearfix"></div>')})}}}),appDirectives.directive("imgUploader",function(){return{templateUrl:"html/share/img-uploader.html"}}),appDirectives.directive("collectionItemsShort",function(){return{templateUrl:"html/share/collection-items-short.html"}}),appDirectives.directive("collectionItems",function(){return{templateUrl:"html/share/collection-items.html"}}),appDirectives.directive("controlBox",function(){return{templateUrl:"html/share/control-box.html"}}),appDirectives.directive("listMetaBox",function(){return{templateUrl:"html/share/list-meta-box.html"}}),appDirectives.directive("resizeItems",function(){return{templateUrl:"html/share/resize-items.html"}}),appDirectives.directive("uploadItems",function(){return{templateUrl:"html/share/upload-items.html"}}),appDirectives.directive("jsonMsgMini",function(){return{templateUrl:"html/share/msg/json-msg-mini.html"}}),appDirectives.directive("jsonMsg",function(){return{templateUrl:"html/share/msg/json-msg.html"}}),appDirectives.directive("jsonOut",function(){return{templateUrl:"html/share/msg/json-out.html"}}),appDirectives.directive("sparqlMsg",function(){return{templateUrl:"html/share/msg/sparql-msg.html"}}),appDirectives.directive("stdOut",function(){return{templateUrl:"html/share/msg/std-out.html"}}),appDirectives.directive("urnServMsg",function(){return{templateUrl:"html/share/msg/urn-serv-msg.html"}}),appDirectives.directive("filterBox",function(){return{templateUrl:"html/share/filter-box.html"}}),appDirectives.directive("navBox",function(){return{templateUrl:"html/share/nav-box.html"}}),appDirectives.directive("slider",function(){return{restrict:"A",link:function(a,b,c){var d=100;b.slider({range:"min",value:c.start*d,min:0,max:d,slide:function(b,e){a[c.change](e.value/d)}})}}}),appDirectives.directive("urnInfo",function(){return{templateUrl:"html/share/urn-info.html"}}),appDirectives.directive("urnUniqBox",function(){return{templateUrl:"html/share/urn-uniq-box.html"}}),appDirectives.directive("userBox",function(){return{templateUrl:"html/share/user-box.html"}}),$(document).foundation();var sel=".button-group .button";$(document).ready(function(){$(window).bind("hashchange",function(){clear(),check()})}),app.service("cropper",["json","imgup","config","urnServ","onto","item","tmpl",function(a,b,c,d,e,f,g){function h(a){m=a;var b=a.split("@");return o=b[0],r=b[1].split(","),f.upload_src(o).then(function(a){return n=a[0].img,i()})}function i(){return d.fresh(d.base+"crop.{{ id }}",function(a){return p=a,j()})}function j(){return g.get("crop").then(function(a){return q=a,k()})}function k(){q["@id"]=p,q[e.pre("represents")]={"@id":m},l()}function l(){var a=c.xhr.json.url+"/data/crop/"+p;return b.crop(n,r[0],r[1],r[2],r[3],a,q).then(function(a){return a})}var m=null,n=null,o=null,p=null,q=null,r=[];return{add:h}}]),app.service("imgup",["$http","$q","$upload","config","user",function(a,b,c,d){function e(b){return a({method:"POST",url:d.imgup.url+"/upload",headers:{"Content-Type":"application/json"},data:{src:b}}).error(function(a){return i(a),a.data}).success(function(a){return i(a),a.data})}function f(b,c,e,f,g){var h={src:b,max_width:c,max_height:e,send_to:f,json:g};return a({method:"POST",url:d.imgup.url+"/resize",headers:{"Content-Type":"application/json"},data:h}).error(function(a){return i(a),a.data}).success(function(a){return i(a),a.data})}function g(b,c,e,f,g,h,j){var k={src:b,x:c,y:e,width:f,height:g,send_to:h,json:j};return a({method:"POST",url:d.imgup.url+"/crop",headers:{"Content-Type":"application/json"},data:k}).error(function(a){return i(a),a.data}).success(function(a){return i(a),a.data})}function h(a){return c.upload({url:d.imgup.url+"/upload",method:"POST",file:a}).error(function(a){return i(a),a.data}).success(function(a){return i(a),a.data})}function i(a){this.msg=a.data}return this.msg="",{upload:h,cp_url:e,resize:f,crop:g,msg:this.msg}}]),app.service("resizer",["json","imgup","config","urnServ","onto","tmpl",function(a,b,c,d,e,f){function g(a,b,c){return n=b,o=c,t=a,h()}function h(){return a.urn(t).then(function(a){return p=a.src[0],i()})}function i(){return a.get(p).then(function(a){return q=a,j()})}function j(){return d.fresh(d.base+"resize.{{ id }}",function(a){return r=a,k()})}function k(){return f.get("resize").then(function(a){return s=a,l()})}function l(){return s["@id"]=r,s[e.pre("memberOf")]["@id"]=q["@id"],m()}function m(){var a=c.xhr.json.url+"/data/resize/"+r,d=q[e.pre("src")]["@id"];return b.resize(d,200,200,a,s).then(function(a){return a})}var n=null,o=null,p=null,q=null,r=null,s=null,t=null;return{add:g}}]),app.service("deleter",["json","onto","user","sparql",function(a,b,c,d){function e(a){return g(a)}function f(a,b){k[k.length-1]={},k[k.length-1][a]=b}function g(b){return a.urn(b).then(function(a){var c=a.src[0];return j(c,b)})}function h(b,c){return a.del(b).then(function(a){f(c,a)})}function i(a){var c=[b.prefixes(),"SELECT ?urn ?verb","WHERE {","?urn ?verb <"+a+">","}"],e=[];return d.search(c.join(" ")).then(function(c){for(var d=0;d<c.length;d++){var f=c[d].urn.value,g=c[d].verb.value;f!=a&&e.push({urn:f,verb:b["short"](g)})}return e})}function j(b){return a.get(b).then(function(){return h(b,e)})}var k=[{}];return{urn:e,log:k,refs:i}}]),app.service("jsonPrep",["onto","user",function(a,b){function c(c){var d=a.pre("creator"),f=a.pre("created");c[d]=b.node(),c[f]=e()}function d(b){var c=a.pre("contributor"),d=a.pre("modified");b[c]=[],b[d]=[]}function e(){return(new TimeStamp).xsd()}return{post:c,put:d}}]),app.service("json",["$http","$q","config","user",function(a,b,c){function d(){return{wait:"WAIT",success:"SUCCESS",error:"ERROR"}}function e(a){s.push(a)}function f(){angular.forEach(s,function(a){a(this.method,this.url,this.status,this.msg)})}function g(a){if(null!=a){var b=n(t,c.xhr.json.url+"/src?urn="+a);return b.then(r,q)}}function h(a){var b={},c=[];for(var d in a)"@context"!=d?b[d]=a[d]:c[0]=angular.toJson(a[d],!0);return c[1]=angular.toJson(b,!0),c}function i(a,b){var c=n(u,o(a),b);return c.then(r,function(){return j(o(a),b)})}function j(a,b){var c=n(v,o(a),b);return c.then(r,q)}function k(a){var b=n(w,o(a));return b.then(r,q)}function l(a){var b=n(t,o(a));return b.then(r,q)}function m(a){var b=n(t,o(a)+"?cmd=ls");return b.then(r,q)}function n(b,c,e){return this.method=b,this.url=c,this.status=d().wait,f(),a({method:b.toUpperCase(),url:c,headers:{"Content-Type":"application/json"},data:p(e)})}function o(a){return 0==a.indexOf("http://")?a:c.xhr.json.url+"/data/"+a}function p(a){return{data:a}}function q(a){if(this.status=d().error,this.msg=angular.toJson(a.data,!0),f(),!angular.isObject(a.data)||!a.data.error){var c="An unknown error occurred.";return b.reject(c)}return a.data}function r(a){return this.status=d().success,this.msg=angular.toJson(a.data,!0),f(),a.data}this.msg="",this.method="",this.status="",this.url="";var s=[],t="GET",u="POST",v="PUT",w="DELETE";return{post:i,put:j,get:l,"delete":k,del:k,ls:m,urn:g,disp:h,on_change:e,msg:this.msg,method:this.method,status:this.status,state:d,url:this.url}}]),app.service("onto",["config",function(a){function b(b){return angular.isDefined(a.ontology[b])}function c(b){for(var c in a.ontology){var d=a.ontology[c],e=d.ns+d.term;if(b==e)return d.prefix+":"+d.term}return b}function d(c){return b(c)?a.ontology[c].prefix+":"+a.ontology[c].term:(console.log("Missing ontology term "+c),null)}function e(c){return b(c)?a.ontology[c].ns+a.ontology[c].term:(console.log("Missing ontology term "+c),null)}function f(c){return b(c)?a.ontology[c].default_value||"":(console.log("Missing ontology term "+c),null)}function g(){var b="",c={};return angular.forEach(Object.keys(a.ontology),function(d){c[a.ontology[d].prefix]||(b=b+" PREFIX "+a.ontology[d].prefix+": <"+a.ontology[d].ns+">"),c[a.ontology[d].prefix]=1}),b+=" PREFIX this: <https://github.com/PerseusDL/CITE-JSON-LD/blob/master/templates/img/SCHEMA.md#>"}function h(){var b=[],c={};for(var d in a.ontology){var e=a.ontology[d];c[e.prefix]||(b.push("PREFIX "+e.prefix+": <"+e.ns+">"),c[e.prefix]=1)}return b}return{"short":c,with_prefix:d,prefix:d,pre:d,with_ns:e,default_value:f,prefixes:g,prefix_array:h}}]),app.service("tmpl",["$http","config",function(a,b){function c(c){return a({method:"GET",url:b.xhr.tmpl.url+"/"+c+".json",headers:{"Content-Type":"application/json"}}).then(function(a){return a.data
})}return{get:c}}]),app.service("urnServ",["sparql","json","host","config",function(a,b,c,d){function e(a){return"  SELECT count( distinct ?o )  WHERE { <"+a+"> ?p ?o }"}function f(b,c){return a.search(e(b)).then(function(a){var d=a[0][".1"].value;return d>0?void c(!1,b):void c(!0,b)})}function g(a,b){var c=a.replace("{{ id }}",h(11,"#aA"));return f(c,function(c,d){1==c?b(d):g(a,b)})}function h(a,b){var c="";b.indexOf("a")>-1&&(c+="abcdefghijklmnopqrstuvwxyz"),b.indexOf("A")>-1&&(c+="ABCDEFGHIJKLMNOPQRSTUVWXYZ"),b.indexOf("#")>-1&&(c+="0123456789");for(var d="";a>0;)d+=c[Math.round(Math.random()*(c.length-1))],a--;return d}function i(a,c){var d={"@context":{urn:"http://data.perseus.org/collections/urn:"},"@id":c};return b.post(a,d)}return{uniq:f,fresh:g,claim:i,base:d.serv.urn_serv.base}}]),app.service("query",["sparql","config","onto","results",function(a,b,c,d){function e(b){var d=h(b),e=c.prefix_array();return e=e.concat(["SELECT count( distinct ?urn )","WHERE {"]),e=e.concat(d.where),e=e.concat(["}"]),a.search(e.join("\n")).then(function(a){return a[0][".1"].value})}function f(b){return a.search(i(b)).then(function(a){return d.list(a)})}function g(a){for(var b=[],c=0;c<a.where.length;c++){var d=a.where[c];if(null!=d){var e={},f=d[d.length-1];if(f instanceof Object&&(e=f),"optional"in e)if(Array.isArray(d[0])){for(var g=[],h=0;h<d.length-1;h++)g.push(k(d[h]));b.push("OPTIONAL { "),b=b.concat(g),b.push("}")}else b.push("OPTIONAL { "+k(d)+" }");else b.push(k(d));"filter"in e&&b.push("FILTER ( "+e.filter+" )")}}return b}function h(a){var b=g(a),c={};c=j(a.where,c);var d=[];for(var e in c)d.push(e);return{where:b,selectors:d}}function i(a){var b=h(a),d=c.prefix_array();return d=d.concat(["SELECT "+b.selectors.join(" "),"WHERE {"]),d=d.concat(b.where),d=d.concat(["}"]),"order_by"in a&&(d=d.concat(["ORDER BY "+a.order_by])),"limit"in a&&(d=d.concat(["LIMIT "+a.limit])),"offset"in a&&(d=d.concat(["OFFSET "+a.offset])),d.join("\n")}function j(a,b){for(var c=0;c<a.length;c++){var d=a[c];if(null!=d){Array.isArray(d[0])&&j(d,b);var e=[0,2];for(var f in e){var g=e[f];"string"==typeof d[g]&&0==d[g].indexOf("?")&&(b[d[g]]=1)}}}return b}function k(a){var b=a[0],d=a[2];return b+" "+c.pre(a[1])+" "+d+" ."}return{get:f,count:e,build:i}}]),app.service("collection",["sparql","results","onto","query","user",function(a,b,c,d,e){function f(){return c.prefixes()}function g(){return a.search(h()).then(function(a){return b.list(a)})}function h(){return"  "+f()+"  SELECT ?urn  WHERE {    ?urn "+c.pre("type")+" 'collection'  }"}function i(c){return a.search(j(c)).then(function(a){return b.list(a)})}function j(a){return"  "+f()+"  SELECT ?urn  WHERE {    ?urn "+c.pre("type")+" 'collection'    FILTER regex( str(?urn), \""+a+'" )  }'}function k(a){var b={where:[["?urn","memberOf","<"+a+">"],["?urn","label","?label",{optional:!0}],["?urn","description","?desc",{optional:!0}],["?urn","created","?time",{optional:!0}],["?urn","represents","?rep",{optional:!0}],["?urn","creator","?user",{optional:!0}],[["?urn","src","?up"],["?res","memberOf","?up"],["?res","src","?thumb"],{optional:!0}]]};return d.get(b).then(function(a){return a})}function l(a){if(null==a)throw"belonging_to() requires user_url";var b={where:[["?urn","type",'"collection"'],["?urn","label","?label"],["?urn","creator","<"+a+">"]]};return d.get(b).then(function(a){return a})}function m(){return l(e.url())}return{get:g,search:i,items:k,belonging_to:l,mine:m}}]),app.service("item",["sparql","results","onto","query",function(a,b,c,d){function e(){return c.prefixes()}function f(a){return"  "+e()+"  SELECT ?urn  WHERE {    ?urn "+c.pre("type")+" 'item'.    "+a+"  }"}function g(c){return a.search(h(c)).then(function(a){return b.list(a)})}function h(a){return f("?urn "+c.pre("src")+" <"+a+">")}function i(c){return a.search(j(c)).then(function(a){return b.list(a)})}function j(a){return f("?urn "+c.pre("memberOf")+" <"+a+">")}function k(a){var b={where:[["<"+a+">","src","?up"],["?res","memberOf","?up"],["?res","src","?thumb",{optional:!0}]]};return d.get(b).then(function(a){return a})}function l(a){var b={where:[["<"+a+">","src","?up"],["?up","src","?img"]]};return d.get(b).then(function(a){return a})}function m(a){var b={where:[["?urn","memberOf","<"+a+">"],["?urn","type",'"roi"'],["?urn","x","?x"],["?urn","y","?y"],["?urn","width","?width"],["?urn","height","?height"],["?urn","label","?label"],["?urn","description","?description"]]};return d.get(b).then(function(a){return a})}return{by_upload:g,by_collection:i,thumb:k,rois:m,upload_src:l}}]),app.service("resize",["sparql","results","onto",function(a,b,c){function d(){return c.prefixes()}function e(a){return"  "+d()+"  SELECT ?urn ?width ?height  WHERE {    ?urn "+c.pre("type")+" 'resize'.    ?urn "+c.pre("memberOf")+" <"+a+">    OPTIONAL { ?urn "+c.pre("width")+" ?width . }    OPTIONAL { ?urn "+c.pre("height")+" ?height . }  }"}function f(c){return a.search(e(c)).then(function(a){return b.list(a)})}return{get:f}}]),app.service("roi",["query","onto","user",function(a){function b(b){var c={where:[["?urn","type",'"roi"'],["?urn","label","?label",{filter:'regex( ?label, "'+b+'", "i" )'}],["?urn","description","?description",{optional:!0}],[["?crop","represents","?urn"],["?crop","type",'"crop"'],["?crop","src","?src"],{optional:!0}]]};return a.get(c).then(function(a){return a})}return{by_label:b}}]),app.service("upload",["sparql","results","onto",function(a,b,c){function d(){return c.prefixes()}function e(c){return a.search(f(c)).then(function(a){return b.list(a)})}function f(a){return"  "+d()+"  SELECT ?urn  WHERE {    <"+a+"> "+c.pre("memberOf")+" ?item .    ?item "+c.pre("src")+" ?urn  }"}return{by_annotation:e}}]),app.service("results",[function(){function a(a){for(var b=[],c=0;c<a.length;c++){var d={};for(var e in a[c])d[e]=a[c][e].value;b.push(d)}return b}function b(a,b){for(var c in b)if(0==a.indexOf(b[c]))return a.replace(b[c],c+":");return a}function c(a,c){for(var d=[],e={},f=0;f<a.length;f++){var g=a[f].urn.value,h=b(a[f].p.value,c),i=a[f].o.value;g in e||(e[g]={}),e[g].urn=g,e[g][h]=i}for(var j in e)d.push(e[j]);return d}return{list:a,more:c}}]),app.service("sparql",["$http","$q","config",function(a,b,c){function d(a){j.push(a)}function e(){angular.forEach(j,function(a){a("whoa",this.query)})}function f(a){var b=i(a);return b.then(g,h)}function g(a){return e(),a.data.results.bindings}function h(a){return e(),a}function i(b){this.query=b;var d=c.xhr.sparql.url+"?query="+encodeURIComponent(b)+"&output=json";return a({method:"GET",url:d,headers:{"Content-Type":"application/json"}})}this.query="";var j=[];return{search:f,on_change:d}}]),app.service("user",["$http","$q","config",function(a,b,c){function d(){var d=b.defer();return null!=f?(d.resolve(),d.promise):(a.get(c.serv.user.ping,{withCredentials:!0}).then(function(a){f=a.data.user,d.resolve()},function(a){g=a,d.reject()}),d.promise)}var e="SERVICE.USER.",f=null,g=null;return{data:function(){return null!=f?f:null},dir:function(){return null!=f?f.uri.dirname():null},id:function(){return null!=f?f.uri:null},url:function(){return null!=f?f.uri:null},node:function(){return null!=f?{"@id":f.uri}:null},name:function(){return null!=f?f.name:null},events:{ok:e+"OK",error:e+"ERROR"},error:function(){return g},check:d,only:!1}}]),app.service("stdout",[function(){function a(a){"object"==typeof a&&(a=angular.toJson(a,!0)),this.msg+=a+"\n"}return this.msg=">>\n",{log:a,msg:this.msg}}]);